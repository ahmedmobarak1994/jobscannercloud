name: Scan Jobs Daily

on:
  schedule:
    # Run twice daily at 9:00 and 17:00 UTC (10:00 and 18:00 CET)
    - cron: '0 9,17 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      clear_cache:
        description: 'Clear cache (force fresh scan)'
        required: false
        type: boolean
        default: false

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Create state directory
        run: |
          mkdir -p .state

      - name: Clear cache (if requested)
        if: github.event.inputs.clear_cache == 'true'
        run: |
          echo "üóëÔ∏è  Clearing state cache for fresh scan..."
          rm -rf .state/*

      - name: Restore state from cache
        uses: actions/cache@v4
        with:
          path: .state/
          key: jobscanner-state-${{ github.run_number }}-${{ github.run_id }}
          restore-keys: |
            jobscanner-state-${{ github.run_number }}-
            jobscanner-state-

      - name: Debug environment
        run: |
          echo "üîç Checking Slack webhook..."
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚úÖ Slack webhook SECRET exists in GitHub"
            echo "   Length: ${#SLACK_WEBHOOK_URL} chars"
          else
            echo "‚ùå Slack webhook SECRET is NOT set in GitHub!"
            echo "   Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          fi
          
          echo "üîç Checking Adzuna credentials..."
          if [ -n "${{ secrets.ADZUNA_APP_ID }}" ] && [ -n "${{ secrets.ADZUNA_APP_KEY }}" ]; then
            echo "‚úÖ Adzuna credentials exist in GitHub secrets"
          else
            echo "‚ö†Ô∏è  Adzuna credentials NOT set - Adzuna scanner will be skipped"
            echo "   Add ADZUNA_APP_ID and ADZUNA_APP_KEY to GitHub secrets"
          fi
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}

      - name: Run job scan
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
        run: |
          python3 jobhunt.py --config config.balanced.json scan

      - name: Save state to cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .state/
          key: jobscanner-state-${{ github.run_number }}-${{ github.run_id }}

      - name: Upload scan logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-logs-${{ github.run_number }}
          path: |
            out/*.log
          retention-days: 7

